---
title: "labvsfield_QMRA"
author: "Camille Zimmer"
date: "2024-03-01"
output: html_document
---

```{r setup, include=FALSE, set.seed(123)}
knitr::opts_chunk$set(echo = TRUE)

#Clear environment
rm(list = ls())

#Load libraries
library(tidyverse)
library(fitdistrplus)
library(readxl)
library(mc2d)
library(truncnorm)

# Define number of Monte Carlo observations we want per draw (currently 100 for the first chunks, will be redefined further down)
nMC = 100

```



# Part I:  define MC draw functions for QMRA 
## Draw for pathogen concentration in the raw water, for each "DW event"
### Draw for campylobacter
```{r draw_campy}

# See "fitenvdata_forQMRAinputs" file for code used to find fit parameters

# Function inputs:
#  nMC: the number of monte carlo draws to carry out
#  plotsdisp: whether to display a summary plot of one of the refill draws
#  Distribution parameters (prevalence and concentration) are initialized within the function

# Function outputs:
#  rawcampyconc: a 21 x nMC dataframe where each column is nMC draws for campylobacter concentration for a given water refill
#  Note: rawcampyconc has units of CFU/L
draw_campy = function(nMC, plotsdisp) {
    
        # See "fitenvdata_forQMRAinputs" code for code and data used to find fit parameters
        # We'll use meanlog = 1.94, sdlog = 2.22 (Units in CFU/100 mL) --> per Pintar et al (2017)
        
        list = list() #create an empty list
        
        # First, draw nMC times for the campy concentration
                for (i in 1:21) {
                    vec = numeric(nMC) #preallocate a numeric vector
                    vec = rlnorm(nMC, meanlog = 1.94, sdlog = 2.22) # Units in CFU/100 mL
                    list[[i]]  = vec
                }
        
        # Wrangle data
        rawcampyconc = do.call("rbind",list)
        rawcampyconc = as.data.frame(rawcampyconc)
        rawcampyconc = t(sapply(rawcampyconc, as.numeric))
        rawcampyconc = as.data.frame(rawcampyconc)


        # Replace some % of values with non-detect to account for prevalence
        # Prevalence taken from Murphy et al (2016), which is a PERT dist with min = 0, mode = 0.25, max = 0.587 (shape factor not specified)
        # https://stackoverflow.com/questions/70401107/r-randomly-changing-values-in-a-dataframe
        # https://stackoverflow.com/questions/72313629/r-randomly-replace-values-with-na
        # In cases where values are replaced with zero, instead replace them with a value from a PDF to reflect the LDL of Campy sampling
        # For campy, the LDL is 1 CFU/100 mL, so 10 CFU in 1 L.  
        # Make function to replace some % of values with a non-detect
            FUNcampy = function(x) {
                censvaluecampy = runif(1, min = 0, max = 1) # Units in CFU/100 mL, define the non-detect value
                probcampy = rpert(1, min = 0, mode = 0.25, max = 0.578) # probability of a non-detect
                sample(c(x, censvaluecampy), 1, prob=c(probcampy,(1 - probcampy))) # Replace values in the rawcampyconc df with non-detects
                }
        rawcampyconc <- as.data.frame(apply(rawcampyconc, 1:2, FUNcampy)) # Use FUNcampy function to replace values; units in CFU/100 mL
        rawcampyconc = rawcampyconc * 10 # Get in units of CFU/1 L

        #Visualise one of the draws (set to lucky #13 for now, could set to be rand(1,21) later)
        if (plotsdisp == TRUE) {
            plot(density(rawcampyconc$V13))
        }

return(rawcampyconc)

}

# Check that it works
rawcampyconc = draw_campy(nMC = nMC, plotsdisp = T) # Units of CFU/L

```

### Draw for Giardia
```{r draw_giardia}

# See "fitenvdata_forQMRAinputs" file for code used to find fit parameters
# We'll use meanlog = 0.6408606, sdlog = 0.7579550; units of oocysts/100 L --> per Lucas (1998)
# 14% prevalence (point value)

# Function inputs:
#  nMC: the number of monte carlo draws to carry out
#  plotsdisp: whether to display a summary plot of one of the refill draws
#  Distribution parameters (prevalence and concentration) are initialized within the function

# Function outputs:
#  rawgiardiaconc: a 21 x nMC dataframe where each column is nMC draws for giardia concentration for a given water refill
#  Note: rawgiardiaconc has units of oocysts/L


draw_giardia = function(nMC, plotsdisp) {
    # Step 1: create data frame with cocnentrations of Giardia
    list = list() #create an empty list
    
    # Populate data frame
    # See "fitenvdata_forQMRAinputs" code for code and data used to find fit parameters
    # We'll use meanlog = 0.6408606, sdlog = 0.7579550; units of oocysts/100 L --> per Lucas (1998)
    # 14% prevalence (point value)
        for (i in 1:21) {
            vec = numeric(nMC) #preallocate a numeric vector
            vec = rlnorm(nMC, meanlog = 0.6408606, sdlog = 0.7579550) # Units in oocysts/100 L
            list[[i]]  = vec
        }
    # data wrangling
    rawgiardiaconc = do.call("rbind",list)
    rawgiardiaconc = as.data.frame(rawgiardiaconc)
    rawgiardiaconc = t(sapply(rawgiardiaconc, as.numeric))
    rawgiardiaconc = as.data.frame(rawgiardiaconc)

    # Step 2: randomly replace 14.2857142857143% of the samples with 0 (see summary spreadsheet with data from Lucas et al)
    # https://stackoverflow.com/questions/70401107/r-randomly-changing-values-in-a-dataframe
    # https://stackoverflow.com/questions/72313629/r-randomly-replace-values-with-na
    # In cases where values are replaced with zero, instead replace them with a value from a PDF to reflect the LDL of Campy sampling
    # For giardia, the LDL is 1 oocyst/100 L, so 0.01 CFU in 1 L.  
    # Make function to replace some % of values with a non-detect
    FUNgiardia = function(x) {
        censvaluegiardia = runif(1, min = 0, max = 1) # Define non-detect value; units in oocysts/100 L
        probgiardia = 0.142857142857143 # Define giardia prevalence
        sample(c(x, censvaluegiardia), 1, prob=c(probgiardia,(1 - probgiardia))) # Randomly replace 14% of values with a non-detct
        }
    rawgiardiaconc <- as.data.frame(apply(rawgiardiaconc, 1:2, FUNgiardia ))  # Units in oocysts/100 L
    rawgiardiaconc = rawgiardiaconc/100  # Get in units of oocysts/1 L


    #Visualise one of the refills (set to lucky #13 for now, could set to be rand(1,21) later)
    if (plotsdisp == TRUE) {
    plot(density(rawgiardiaconc$V13))
    }
    
    # Output value
    return(rawgiardiaconc)
}

# Check that it works
rawgiardiaconc = draw_giardia(nMC = nMC, plotsdisp = T) # Units of oocysts/1 L

```

## Populate dataframes with an LRV
```{r make LRV dataframe}

## Function to make a matrix out of a given LRV
# Simply takes an input LRV and makes an nxn dataframe populated with it
# Used to make an 21 x nMC dataframe of LRVs for calculations

# Inputs
#   LRV: point value to be replicated into dataframe
#   nrows: how many rows in the df, should be nMC
#   ncols: how many columns in the df, should be 21

# Outputs
#   LRVs: an ncols x nrows dataframe populated with LRV in every cell

FUNmakeLRVmx = function(LRV, nrows, ncols){
    
    LRVs = rep(LRV, times = nrows)
    LRVs = data.frame(LRVs)
    LRVs = cbind(LRVs, rep(LRVs[1], (ncols-1)))
    colnames(LRVs) = 1:ncol(LRVs)
    return(LRVs)
    
}



#Check using the first entry of the LRVs_forsummary input data table
LRVs_Ecoli = FUNmakeLRVmx(LRV = 4.19, nrows = nMC, ncols = 21)
LRVs_yeast = FUNmakeLRVmx(LRV = 3.73, nrows = nMC, ncols = 21)

```

## Draw for drinking water consumption in each "DW event"
```{r draw_DW_consumption}

# Based on curve fitting of survey data, we can assume that reported DW consumed in a day follows a truncated normal distribution
# mean = 0.816667 L, SD = 0.3496667 L, lower limit = 0.25 L **This is per water refill, NOT per day** (21 refills in a 7-day trip)
# see "fitenvdata_forQMRA" R code for how those parameters were generated


## Define function to make MC draws for water consumed per refill
# Inputs
#   nMC: the number of monte carlo draws to carry out
#   plotsdisp: whether to display a summary plot of one of the refill draws
#   Distribution parameters (volume of water consumed per refill) are initialized within the function
# Outputs
#   DWvol: a 21 x nMC dataframe populated for draws of the volume of water consumed per refill 
#          Units in L per refill (21 refills in a 7-day trip)


drawDW = function(nMC, plotsdisp){

    list = list() #create an empty list
    
    # Make nMC draws for volume of water consumed per refill
    for (i in 1:21) {
        vec = numeric(nMC) #preallocate a numeric vector
        mean = 2.446786*(1/3)
        sd = 1.049*(1/3)
        vec = rtruncnorm(n = nMC, a = 0.25, b = Inf, mean = mean, sd = sd) # Trunate at 0.25 L, or half of the mean
        list[[i]]  = vec
    }
    
    # Wrangle data
    DWvol = do.call("rbind",list)
    DWvol = as.data.frame(DWvol)
    DWvol = t(sapply(DWvol, as.numeric))
    DWvol = as.data.frame(DWvol)
    
    #Visualise one of the draws (set to lucky #13 for now, could set to be rand(1,21) later)
    if (plotsdisp == TRUE) {
    plot(density(DWvol$V13))
    }
    
    # DWvol units in L per refill (21 refills per 7-day trip)
    return(DWvol)

}

# Check that it works
DWvol = drawDW(nMC = nMC, plotsdisp = T)

```

## Calculate pathogen exposure per DW event and over the 7-day backpacking trip
```{r calc_exposure}

### Step 1: Calculate exposure in each of the 21 DW refills
## Reminder: conc of campy and giardia should be #/L before feeding to this function
# I.e., raworgconc should be in units of organisms per liter

# Define function to calculate the exposure to a given pathogen during each of the 21 refills
# Inputs
#   LRVs: a 21 x nMC dataframe populated with the point-value LRV for the water treatment device (see chunk "Populate dataframes with LRV")
#   raworgconc: a 21 x nMC dataframe populated with the MC draws for pathogen concentration in water (units of #/L)
#               see the "Draw for campylobacter" and "draw for giardia" chunks
#   DWvol: a 21 x nMC dataframe populated with the nMC draws for water volume consumed per refill (units of L per refill)
# Outputs
#   exposure: a 21 x nMC dataframe with each cell containing the number of pathogens consumed per refill


calc_exposure = function(LRVs, raworgconc, DWvol, plotsdisp) {
    
    # Step 1: Calculate what the pathogen concentration will be in the drinking water
    survival = 10^(-1*LRVs) # Units as a % of the number in the raw water [unitless]
    DW_orgconc = raworgconc * survival # Units of #organisms/1 L
    
    # Step 2: Exposure per draw of water
    # exposure = volume of water consumed in the draw [L] * pathogen concentration in that water [#/L]
    exposure = DWvol * DW_orgconc # Units of #organisms drunk in the refill event
    
    if (plotsdisp == TRUE) {
    plot(density(exposure$V13))
    }
    
    # exposure is the number of pathogens consumed per refill (units of #/refill)
    return(exposure)
    
}

# Check it works
exposure_campy = calc_exposure(LRVs = LRVs_Ecoli, raworgconc = rawcampyconc, DWvol = DWvol, plotsdisp = T)  # Units of CFU campylobacter drunk in the refill event
exposure_giardia = calc_exposure(LRVs = LRVs_yeast, raworgconc = rawgiardiaconc, DWvol = DWvol, plotsdisp = T)  # Units of Giardia oocysts drunk in the refill event


## Step 2: Sum across all 21 DW refills --> this will be the total pathogens consumed in a 7-day backpacking trip
# Note: This is the first of three model endpoints

# Define a function to calculate the total number of pathogens consumed in a 7-day backpacking trip
# Inputs
#   exposure: the output from the function calc_exposure, 21 x nMC matrix with each cell as the number of pathogens consumed per refills
# Outputs
#   exposure_trip: the total number of pathogens consumed in a 7-day backpacking trip (units of # of pathogens)


## NOTE: perhaps call the previous two functions within this one?? 

calc_tripexposure = function(exposure, plotsdisp) {
    
    # Sum all the 21 exposures across the rows
    exposure_trip = exposure %>%
        mutate(sum = rowSums(.[1:21]))
    exposure_trip = exposure_trip$sum
    
    #Display
    if (plotsdisp == TRUE) {
        plot(density(exposure_trip))  
    }
    
    # Output is exposure_trip, total number of pathogens consumed per trip
    return(exposure_trip)
}

# Check it works
exposure_campy_trip = calc_tripexposure(exposure = exposure_campy, plotsdisp = T)  # Units of total CFU campylobacter drunk on a 7-day backpacking trip
exposure_giardia_trip = calc_tripexposure(exposure = exposure_giardia, plotsdisp = T)  # Units of Giardia oocysts drunk on a 7-day backpacking trip

```


## Calculate P(inf) per refill
```{r calc_Pinf_refill}

## Campylobacter ## 

# From Medema (1996) we have a MLE Beta-Poisson model with alpha = 0.145 and N50 = 890
# This model is not used by Murphy (2016) but is used by Bivins (2019) -- although he also uses the Teunis model

# NOTE: maybe put in the Teunis model and weight them 50/50? For later

# Define function to calculate the probability of infection with Campylobacter per refill
# Inputs
#   exposure_campy: a 21 x nMC dataframe with each cell containing the number of campylobacter consumed per refill
#                   see chunk "calc_exposure" for details
# Outputs
#   Pinf_campy: a 21 x nMC with each cell containing the Pinf with campylobacter per refill

Pinf_c = function(exposure_campy, plotsdisp) {
    
    # Define Pinf parameters
    alpha = 0.145
    N50 = 890
    beta = 7.59
    
    # Calculate Pinf_campy
    Pinf_campy = 1 - (1+(exposure_campy*((2^(1/alpha) - 1)/N50)))^(-1*alpha)
    
    # Plot lucky #13
        if (plotsdisp == TRUE) {
            plot(density(Pinf_campy$V13))
        }
    # Return output
    return(Pinf_campy)
}

# Check it works
Pinf_campy = Pinf_c(exposure_campy = exposure_campy, plotsdisp = T)

## Giardia ##

# Rose et al (1991) is used by Murphy (2016) and recommended by WHO (2016)
# Exponential calculation with r = 0.0199

# Define function to calculate the probability of infection with Giardia per refill
# Inputs
#   exposure_giardia: a 21 x nMC dataframe with each cell containing the number of giardia consumed per refill
#                   see chunk "calc_exposure" for details
# Outputs
#   Pinf_giardia: a 21 x nMC with each cell containing the Pinf with giardia per refill  

Pinf_g = function(exposure_giardia, plotsdisp) {
    
    # Define Pinf parameters
    r = 0.0199
    
    # Calculate Pinf
    Pinf_giardia = 1-exp(-1*r*exposure_giardia)
    
    # Plot lucky #13
        if (plotsdisp == TRUE) {
            plot(density(Pinf_giardia$V13))
        }
    # Return output
    return(Pinf_giardia)
}

# Check it works
Pinf_giardia = Pinf_g(exposure_giardia = exposure_giardia, plotsdisp = T)
```


## Calculate total P(inf) for the 7-day trip
```{r calc_Pinf_trip}

## Calculate the overall probability of infection for the 7-day backpacking trip 
# Note: This is the second of three model endpoints
# Formula -->  Pinf_trip = 1 - [(1-Pinf, refill 1)*(1-Pinf, refill 2)...*(1-Pinf, refill 21)]

# Define function to do calculation
# Inputs
#   Pinf: a 21 x nMC with each cell containing the Pinf with the pathogen per refill
# Outputs
#   Pinf_trip: a 1 x nMC dataframe with the overall probability of infection for the 7-day backpacking trip (unitless)

Pinf_trip = function(Pinf, plotsdisp) {
    
    # Do calculations
    Pinf_oneminus = 1-Pinf
    Pinf_trip = Pinf_oneminus %>%
        mutate(prod = Reduce(`*`, .))
    Pinf_trip = Pinf_trip$prod
    Pinf_trip = 1-Pinf_trip
    
    # Plot
    if (plotsdisp == TRUE) {
        plot(density(Pinf_trip))  
    }
    
    # Return output
    return(Pinf_trip)
}

# Check it works
Pinf_campy_trip = Pinf_trip(Pinf = Pinf_campy, plotsdisp = T)  # Probability of infection with Campylobacter for a 7-day backpacking trip
Pinf_giardia_trip = Pinf_trip(Pinf = Pinf_giardia, plotsdisp = T)  # Probability of infection with Campylobacter for a 7-day backpacking trip

```


## Calculate P(ill) for entire trip
```{r calc_Pill_trip}


# Define function to calculate the probability of illness given infection

# Pill = Pinf*Pillinf
# Use Pillinf from Murphy (2016): a uniform distribution (originally from USEPA, 2010)
# Campy has min = 0.1, max = 0.6 
# Giardia has min = 0.2, max = 0.7

# Inputs
#   nMC: the number of monte carlo draws to carry out
#   min: the mimimum of the uniform distribution of Pillinf
#   max: the maximum of the uniform distribution of Pillinf
# Outputs
#   Pill_trip: the overall probability of having a symptomatic illness from the 7-day backpacking trip

Pill_trip = function(nMC, Pinf_trip, min, max, plotsdisp) {
    
    # MC draws 
    Pillinf = runif(nMC, min = min, max = max) # Probability of illness given infection
    Pill_trip = Pinf_trip * Pillinf # Probability of illness given the probability of infection
    
    # Display
    if (plotsdisp == TRUE) {
        plot(density(Pill_trip))  
    }
    
    # Output
    return(Pill_trip)
    
    
}

# Try function
Pill_campy_trip = Pill_trip(nMC = nMC, Pinf_trip = Pinf_campy_trip, min = 0.1, max = 0.6 , plotsdisp = T)
Pill_giardia_trip = Pill_trip(nMC = nMC, Pinf_trip = Pinf_giardia_trip, min = 0.2, max = 0.7, plotsdisp = T)
```


## Calculate DALYs per trip
```{r calc_DALYs}

# Define function to calculate the total DALYs per 7-day backpacking trip

# DALYs per illness = Pill * S * DW * number of people or life years (per Bivins 2019)
# Where:
# Pill was calculated in the last chunk


# Inputs
#   Pill_trip: the overall probability of having a symptomatic illness from the 7-day backpacking trip
#   S: the susceptible fraction; for both campy and giardia, S = 100%
#   DW: DALY weighting, the expected DALY weight per illness/case
#   n_campingtrips: how many camping trips to calculate for. For our purposes here, it will always be 1 but if we were calculating DALYs on a                      per summer basis it could be the number of people hiking the JDF per summer
# Outputs
#   DALYs: Total DALYs per 7-day backpacking trip

calcDALYs = function(Pill_trip, S, DW, n_campingtrips, plotsdisp) {
    
    # Calculations
    DALYs = Pill_trip * S * DW * n_campingtrips
    
    # Display
    if (plotsdisp == TRUE) {
        plot(density(DALYs))  
    }
    # Output
    return(DALYs)
}


## Try the function out

# Initialize values
# DW_campy = 4.6 per 1000 cases --> From WHO (2016), used in Bivins (2019)
DW_campy = 4.6/1000 # Units of DALY per illness case
# DW_giardia = 1.7 per 1000 cases --> From Health Canada (2012)
DW_giardia = 1.7/1000   # Units of DALY per illness case
# 100% susceptibility
S = 1
# If n_campingtrips = 1, then the DALYs are in units of DALY per person per camping trip
n_campingtrips = 1

# Use functions
DALY_campy = calcDALYs(Pill_trip = Pill_campy_trip, S = S, DW = DW_campy, n_campingtrips = n_campingtrips, plotsdisp = T)  # Units of YLL per year of backpackers hiking
DALY_giardia = calcDALYs(Pill_trip = Pill_giardia_trip, S = S, DW = DW_giardia, n_campingtrips = n_campingtrips, plotsdisp = T)  # Units of YLL per year of backpackers hiking

```


